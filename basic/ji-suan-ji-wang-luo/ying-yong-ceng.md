# 应用层

## 域名系统 <a id="%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F"></a>

DNS是一个分布式数据库，提供了主机名和IP地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。

域名具有层次结构，从上往下以此为：根域名、顶级域名、二级域名。

![](../../.gitbook/assets/image%20%2895%29.png)

DNS可以使用UDP或者TCP进行传输，使用的端口号多为53.在大多数情况下DNS使用UDP进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和快重传从而保证可靠性。

在这些情况下会使用TCP进行传输：

* 如果返回的响应超过512字节（UDP最大只支持512字节数据）
* 区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）

## 文件传送协议 <a id="%E6%96%87%E4%BB%B6%E4%BC%A0%E9%80%81%E5%8D%8F%E8%AE%AE"></a>

FTP使用TCP进行连接，它需要两个连接来传送一个文件：

* 控制连接：服务器打开端口号21等待客户的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
* 数据连接：用来重送一个文件数据。

根据数据连接是否是服务器端主动建立，FTP有主动和被动式两种模式：、

* 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为20，客户端的端口号随机，但是必须大于1024，因为0~1023是熟知端口号。

![](../../.gitbook/assets/image%20%2844%29.png)

* 被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己设定，服务器端的端口号随机。

![](../../.gitbook/assets/image%20%2855%29.png)

主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。当时被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

## 动态主机配置协议 <a id="%E5%8A%A8%E6%80%81%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E5%8D%8F%E8%AE%AE"></a>

DHCP\(Dynamic Host Configuration Protocol\)提供了即插即用的联网方式，用户不再需要手动配置IP地址等信息。

DHCP配置的内容不仅是IP地址，还包括子网掩码，网关IP地址。

DHCP工作过程如下：

1. 客户端发送Discover报文，该报文的目的地址为255.255.255.255：67，源地址为0.0.0.0：68，被放入UDP中，该报文被广播到同一个子网的所有主机上，如果客户端和DHCP服务器不在一个子网，就需要使用中继代理。
2. DHCP服务器收到Discover报文之后，发送Offer报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个DHCP服务器提供的信息，因此客户端也需要选择。
3. 如果客户端选择了某个DHCP服务器提供的信息，那么就发送Request报文给DHCP服务器。
4. DHCP服务器发送Ack报文，表示客户端此时可以使用提供给它的信息。

![](../../.gitbook/assets/image%20%2854%29.png)

## 远程登陆协议 <a id="%E8%BF%9C%E7%A8%8B%E7%99%BB%E9%99%86%E5%8D%8F%E8%AE%AE"></a>

TELENT用于登录到远程主机上，并且远程主机上的输出也会返回。

TELNET可以适应许多计算机和操作系统的差异，例如不同操作系统的换行符定义。

## 电子邮件协议 <a id="%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6%E5%8D%8F%E8%AE%AE"></a>

一个电子邮件系统由三部分组成：用户代理、邮件服务器及邮件协议。

邮件协议包含发送协议和读取协议，发送协议常用SMTP，读取协议常用POP3和IMAP。

### 1.SMTP <a id="1.SMTP"></a>

SMTP只能发送ASCII码，而互联网邮件扩充MIME可以发送二进制文件。MIME并没有改动或者取代SMTP，而是增加了邮件主体的结构，定义了非ASCII码的编码规则。

![](../../.gitbook/assets/image%20%2819%29.png)

### 2.POP3 <a id="2.POP3"></a>

POP3的特点是只要用户从服务器上读取了邮件，就把该邮件删除。

但最新版本的POP3可以不删除邮件。

### 3.IMAP <a id="3.IMAP"></a>

IMAP协议中客户端和服务器上的邮件保持同步，如果不手动删除邮件，那么服务器上的邮件也不会被删除。IMAP这种做法可以让用户随时随地地去访问服务器上的邮件。

## Web页面请求过程 <a id="Web%E9%A1%B5%E9%9D%A2%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B"></a>

### 1.DHCP配置主机信息 <a id="1.DHCP%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF"></a>

* 假设主机最开始没有IP地址以及其它信息，那么就需要先使用DHCP来获取。
* 主机生成一个DHCP请求报文，并将这个报文放入具有目的端口67和源端口68的UDP报文段中。
* 该报文段则被放入在一个具有广播IP目的地址（255.255.255.255）和源IP地址（0.0.0.0）的IP数据报中。
* 该数据报则被放置在MAC帧中，该帧具有目的地址FF:FF:FF:FF:FF:FF，将广播到与交换机连接的所有设备。
* 连接在交换机的DHCP服务器收到广播帧之后，不断向上分解得到IP数据报、UDP报文段、DHCP请求报文，之后生成DHCP ACK报文，该报文包含以下信息：IP地址、DNS服务器的IP地址、默认网关路由器的IP地址和子网掩码。该报文被放入UDP报文段中，UDP报文段又被放入IP数据报中，最后放入MAC帧中。
* 该帧的目的地址是请求主机的MAC地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了MAC地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。
* 主机接收到该帧后，不断分解得到DHCP报文。之后就配置它的IP地址、子网掩码和DNS服务器的IP地址，并在其IP转发表中安装默认网关。

### 2.ARP解析MAC地址 <a id="2.ARP%E8%A7%A3%E6%9E%90MAC%E5%9C%B0%E5%9D%80"></a>

* 主机通过浏览器生成一个TCP套接字，套接字向HTTP服务器发送HTTP请求。为了生成该套接字，主机需要知道网站的域名对应的IP地址。
* 主机生成一个DNS查询报文，该报文具有53号端口，因为DNS服务器的端口号是53.
* 该DNS查询报文被放入目的地址为DNS服务器IP地址的IP数据报中。
* 该IP数据报被放入一个以太网帧中，该帧将发送到网关路由器。
* DHCP过程只知道网关路由器的IP地址，为了获取网关路由器的MAC地址，需要使用ARP协议。
* 主机生成一个包含目的地址为网关路由器IP地址的ARP查询报文，将该ARP查询报文放入一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。
* 网关路由器接收到该帧后，不断向上分解得到ARP报文，发现其中的IP地址和其接口的IP地址匹配，因此就发送一个ARP回答报文，包含了它的MAC地址，发回给主机。

### 3.DNS解析域名 <a id="3.DNS%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D"></a>

* 知道了网关路由器的MAC地址后，就可以继续DNS的解析过程了。
* 网关路由器接收到包含DNS查询报文的以太网帧后，抽取出IP数据报，并根据转发表决定该IP数据报应该转发的路由器。
* 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达DNS服务器的路由表项。
* 到达DNS服务器后，DNS服务器抽取出DNS查询报文，并在DNS数据库中查找带解析的域名。
* 找到DNS记录之后，发送DNS回答报文，将该回答报文放入UDP报文段中，然后放入IP数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

### 4.HTTP请求页面 <a id="4.HTTP%E8%AF%B7%E6%B1%82%E9%A1%B5%E9%9D%A2"></a>

* 有了HTTP服务器的IP地址后，主机就能够生成TCP套接字，该套接字将用于向Web服务器发送DHCP GET报文。
* 在生成TCP套接字之前，必须先与HTTP服务器进行三次握手来建立连接。生成一个具有目的端口80的TCP SYN报文段，并向HTTP服务器发送该报文段。
* HTTP服务器收到该报文段后，生成TCP SYN ACK报文段，发回给主机。
* 连接建立后，浏览器生成HTTP GET报文，并交付给HTTP服务器。
* HTTP服务器从TCP套接字读取HTTP GET报文，生成一个HTTP响应报文，将Web页面内容放入报文主体中，发回给主机。
* 浏览器收到HTTP响应报文后，抽取出Web页面内容，之后进行渲染，显示Web页面。

